<!-- ========================  MAP FROM MAPBOX -->
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.23.0/mapbox-gl.js'></script>
 <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>

<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.23.0/mapbox-gl.css' rel='stylesheet' />

 <!-- /*<style>
     body { margin:0; padding:0; }
     #map { position:absolute; top:0; bottom:0; width:100%; opacity: 0.4; transition: 1s;}
 </style>*/ -->

 <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v2.2.0/mapbox-gl-directions.js'></script>
 <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v2.2.0/mapbox-gl-directions.css' type='text/css' />





<!-- .........................   MAP on the page-->
 <div id='map' class='map pad2'></div>

<!-- .........................   MAP on the page-->





<!-- ========================  MAP FROM MAPBOX  script-->
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibWFnZGFsZW5hYmlhbG9uIiwiYSI6ImNpc2p3cnUwczAycXcyem9jYXpzZWZ6eW4ifQ.RWDUb9U9vdUlNuKcPGJDhg';

   var map = new mapboxgl.Map({
       container: 'map',
      //  style: 'mapbox://styles/mapbox/streets-v9',
       style: 'mapbox://styles/mapbox/dark-v9',
       center: [144.958998, -37.818535],
       zoom: 13
   });


   map.addControl(new mapboxgl.Directions());


   var directions = new mapboxgl.Directions({
     unit: 'metric', // Use the metric system to display distances.
     profile: 'driving', // Set the initial profile to walking.
     container: 'directions', // Specify an element thats not the map container.
     proximity: [144.96, -37.82] // Give search results closer to these coordinates higher priority.
   });






  map.on('load', function() {



    //========================= GA-conf logo / location
    var gaConf =

      {
        type: "FeatureCollection",
        features: [
          {
            "type": "Feature",
            "geometry": {
              "type": "Point",
              "coordinates": [
                144.958998,
                -37.818535
              ]
            },
            "properties": {
              "website": "https://generalassemb.ly/",
              "address": "12A/Williams St CBD",
              "city": "Melbourne Vic",
              "country": "Australia",
              "date_of_conf": "19 Feb 2017",
              "time": "10am - 6pm"
            }
          },
        ]
      }

      map.addSource("places", {
        "type": "geojson",
        "data": gaConf
      });


      gaConf.features.forEach(function(marker_ga) {
        // Create a div element for the marker_ga
        var ga_logo = document.createElement('div');
        // Add a class called 'marker_ga' ga_icon to each div
        ga_logo.className = 'ga_icon popup';
        // By default the image for your custom marker_ga will be anchored by its top left corner. Adjust the position accordingly
        ga_logo.style.left='-28px';
        ga_logo.style.top='-46px';



        // Create the custom marker_gas, set their position, and add to map
        var markerGA = new mapboxgl.Marker(ga_logo)
            .setLngLat(marker_ga.geometry.coordinates)
            .addTo(map);


        ga_logo.addEventListener('click', function(e) {
          //  window.alert("Website: " + marker_ga.properties.website + " | Conference date: " + marker_ga.properties.date_of_conf);

            //create span with the message inside the popup
            var span = document.createElement('span');
            span.className = 'popuptext';
            span.id = 'myPopup';

            var t = document.createTextNode("WDI Conference " + marker_ga.properties.date_of_conf + " " + marker_ga.properties.address);
            span.appendChild(t)


            ga_logo.appendChild(span)
            console.log(span)

            //once ga_logo was clicked toggle popup and show it
            var popup = document.getElementById('myPopup');
            popup.classList.toggle('show');

        });







        // function createPopUp(currentFeature) {
        //   var popUps = document.getElementsByClassName('mapboxgl-popup');
        //   console.log(popUps)
        //   // Check if there is already a popup on the map and if so, remove it
        //   if (popUps[0]) popUps[0].remove();
        //
        //   var popup = new mapboxgl.Popup({closeOnClick: false})
        //     .setLngLat(currentFeature.geometry.coordinates)
        //     .setHTML('<h3>Sweetgreen</h3>' +
        //       '<h4>' + currentFeature.properties.address + '</h4>')
        //     .addTo(map);
        // }
        //
        //
        // map.on('click', function (e) {
        //       // Query all the rendered points in the view
        //       var features = map.queryRenderedFeatures(e.point, { layers: ['places'] });
        //       if (features.length) {
        //       	var clickedPoint = features[0];
        //         // 1. Fly to the point
        //         // flyToStore(clickedPoint);
        //         // 2. Close all other popups and display popup for clicked store
        //         createPopUp(clickedPoint);
        //         // 3. Highlight listing in sidebar (and remove highlight for all other listings)
        //         // var activeItem = document.getElementsByClassName('active');
        //         // if (activeItem[0]) {
        //         //   activeItem[0].classList.remove('active');
        //         // }
        //         // Find the index of the store.features that corresponds to the clickedPoint that fired the event listener
        //         var selectedFeature = clickedPoint.properties.address;
        //
        //         for (var i = 0; i < gaConf.features.length; i++ ) {
        //           if (gaConf.features[i].properties.address === selectedFeature) {
        //                 selectedFeatureIndex = i;
        //           }
        //         }
        //         // Select the correct list item using the found index and add the active class
        //         // var listing = document.getElementById('listing-' + selectedFeatureIndex);
        //         // listing.classList.add('active');
        //       }
        // });

      });





      // ===========================  parking locations
      $.ajax({
        url: "https://data.melbourne.vic.gov.au/resource/9xmh-yeh2.json",
        type: "GET",
        data: {
          "$limit" : 800,
          "$$app_token" : "q0QvItQ7Te62kF5Yr2ebfoeNs"
        }
      }).done(function(data) {


          var geojson = {
            type: 'FeatureCollection',
            features: []
          };

          data.forEach(function(e) {
            geojson.features.push({
              type: 'Feature',
              properties: {
                "parking_type": e.parking_type,
                "number_of_spaces": e.parking_spaces,
                "iconSize": [10, 10]
              },
              geometry: {
                "type": "Point",
                "coordinates": [
                  e.x_coordinate.coordinates[0],
                  e.x_coordinate.coordinates[1],
                ]
              }
            });
          // console.log(e.x_coordinate.coordinates)
          });

          geojson.features.forEach(function(marker) {

              // create a DOM element for the marker
              var el = document.createElement('div');
              el.className = 'parking-icon icon-dc';

              var t = document.createTextNode("p");
              el.appendChild(t);


              el.addEventListener('click', function() {
                  window.alert("Parking type: " + marker.properties.parking_type + " | Number of spaces: " + marker.properties.number_of_spaces);
              });

            // add marker to map
            new mapboxgl.Marker(el, {offset: [-marker.properties.iconSize[0] / 2, -marker.properties.iconSize[1] / 2]})
                .setLngLat(marker.geometry.coordinates)
                .addTo(map);
        });

        //here should be creating div popup
      })




       // ===========================  autolocation
       navigator.geolocation.getCurrentPosition(function(geo) {
        // console.log(geo)
        $('#map').css({
          'opacity': '1'
        });
        $('#mapbox-directions-origin-input , #mapbox-directions-destination-input, .mapbox-form-label, .js-reverse-inputs').css({
          'display': 'none'
        });
        // $('.mapbox-directions-component mapbox-directions-inputs').hide();
         directions.setOrigin([ geo.coords.longitude, geo.coords.latitude ]);
         directions.setDestination([144.958998, -37.818535]);    // On load, set the origin to GA Melbourne
       });

  });








// ===========================  directions
   directions.on('route', function(e) {
    //  console.log(e.route); // Logs the current route shown in the interface.
  //  map.setZoom(13);
     map.scrollZoom.disable();

     function flyToLocation(currentFeature) {
        map.flyTo({
          center: currentFeature.geometry.coordinates,
          zoom: 15
        });
      }
   });


   map.addControl(new mapboxgl.Navigation());


</script>
<!-- ========================  MAP FROM MAPBOX  script-->







<!-- ========================  WEATHER  -->
<!-- <div class = "weather">
  <div id="cont_21d71ee597e69cbb9fd0e2e85960b55e"></div>
</div>
<script type="text/javascript" async src="https://www.theweather.com/wid_loader/21d71ee597e69cbb9fd0e2e85960b55e"></script> -->
<!-- ========================  WEATHER  -->





<!-- ========================  PARKING MAP  -->
<!-- <div><iframe width="760px" title="wdi_conf" height="646px" src="https://data.melbourne.vic.gov.au/w/m4j7-darc/spy9-nmud?cur=jBdT_JGn9RO&from=root" frameborder="0"scrolling="no"><a href="https://data.melbourne.vic.gov.au/Property-Planning/wdi_conf/m4j7-darc" title="wdi_conf" target="_blank">wdi_conf</a></iframe></div> -->
<!-- ========================  PARKING MAP  -->

<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-_tjRXvZwDBMsFKx2He46Jv3MBw-_oT0"
        async defer></script> -->
